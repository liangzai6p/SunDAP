<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunyard.ars.file.dao.oa.CheckOffMapper">
    <resultMap id="BaseResultMap" type="com.sunyard.ars.file.pojo.oa.CheckOff">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="OCCUR_DATE" jdbcType="VARCHAR" property="occurDate" />
        <id column="SITE_NO" jdbcType="VARCHAR" property="siteNo" />
        <id column="OPERATOR_NO" jdbcType="VARCHAR" property="operatorNo" />
        <result column="CITY_NO" jdbcType="VARCHAR" property="cityNo" />
        <result column="STREAM_CHECKOFF" jdbcType="CHAR" property="streamCheckoff" />
        <result column="SUBJECT_CHECKOFF" jdbcType="CHAR" property="subjectCheckoff" />
        <result column="FEE_CHECKOFF" jdbcType="CHAR" property="feeCheckoff" />
        <result column="ALL_CHECKOFF" jdbcType="CHAR" property="allCheckoff" />
        <result column="CHECK_WORKER" jdbcType="VARCHAR" property="checkWorker" />
        <result column="FORCE_REASON" jdbcType="VARCHAR" property="forceReason" />
        <result column="FORCE_FLAG" jdbcType="VARCHAR" property="forceFlag" />
        <result column="CHECK_DATE" jdbcType="CHAR" property="checkDate" />
        <result column="ARCHIVE_DATE" jdbcType="CHAR" property="archiveDate" />
    </resultMap>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        OCCUR_DATE, SITE_NO, OPERATOR_NO, CITY_NO, STREAM_CHECKOFF, SUBJECT_CHECKOFF, FEE_CHECKOFF,
        ALL_CHECKOFF, CHECK_WORKER, FORCE_REASON, FORCE_FLAG, CHECK_DATE,ARCHIVE_DATE
    </sql>
    <select id="selectByPrimaryKey" parameterType="map" resultMap="BaseResultMap">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select
        <include refid="Base_Column_List" />
        from FL_CHECKOFF_TB
        where OCCUR_DATE = #{occurDate,jdbcType=VARCHAR}
        and SITE_NO = #{siteNo,jdbcType=VARCHAR}
        and OPERATOR_NO = #{operatorNo,jdbcType=VARCHAR}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="map">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        delete from FL_CHECKOFF_TB
        where OCCUR_DATE = #{occurDate,jdbcType=VARCHAR}
        and SITE_NO = #{siteNo,jdbcType=VARCHAR}
        and OPERATOR_NO = #{operatorNo,jdbcType=VARCHAR}
    </delete>
    <insert id="insert" parameterType="com.sunyard.ars.file.pojo.oa.CheckOff">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into FL_CHECKOFF_TB (OCCUR_DATE, SITE_NO, OPERATOR_NO,
        CITY_NO, STREAM_CHECKOFF, SUBJECT_CHECKOFF,
        FEE_CHECKOFF, ALL_CHECKOFF, CHECK_WORKER,
        FORCE_REASON, FORCE_FLAG, CHECK_DATE,ARCHIVE_DATE
        )
        values (#{occurDate,jdbcType=VARCHAR}, #{siteNo,jdbcType=VARCHAR}, #{operatorNo,jdbcType=VARCHAR},
        #{cityNo,jdbcType=VARCHAR}, #{streamCheckoff,jdbcType=CHAR}, #{subjectCheckoff,jdbcType=CHAR},
        #{feeCheckoff,jdbcType=CHAR}, #{allCheckoff,jdbcType=CHAR}, #{checkWorker,jdbcType=VARCHAR},
        #{forceReason,jdbcType=VARCHAR}, #{forceFlag,jdbcType=VARCHAR}, #{checkDate,jdbcType=CHAR}, #{archiveDate,jdbcType=CHAR}
        )
    </insert>
    <insert id="insertSelective" parameterType="com.sunyard.ars.file.pojo.oa.CheckOff">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into FL_CHECKOFF_TB
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="occurDate != null">
                OCCUR_DATE,
            </if>
            <if test="siteNo != null">
                SITE_NO,
            </if>
            <if test="operatorNo != null">
                OPERATOR_NO,
            </if>
            <if test="cityNo != null">
                CITY_NO,
            </if>
            <if test="streamCheckoff != null">
                STREAM_CHECKOFF,
            </if>
            <if test="subjectCheckoff != null">
                SUBJECT_CHECKOFF,
            </if>
            <if test="feeCheckoff != null">
                FEE_CHECKOFF,
            </if>
            <if test="allCheckoff != null">
                ALL_CHECKOFF,
            </if>
            <if test="checkWorker != null">
                CHECK_WORKER,
            </if>
            <if test="forceReason != null">
                FORCE_REASON,
            </if>
            <if test="forceFlag != null">
                FORCE_FLAG,
            </if>
            <if test="checkDate != null">
                CHECK_DATE,
            </if>
            <if test="archiveDate != null">
                ARCHIVE_DATE,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="occurDate != null">
                #{occurDate,jdbcType=VARCHAR},
            </if>
            <if test="siteNo != null">
                #{siteNo,jdbcType=VARCHAR},
            </if>
            <if test="operatorNo != null">
                #{operatorNo,jdbcType=VARCHAR},
            </if>
            <if test="cityNo != null">
                #{cityNo,jdbcType=VARCHAR},
            </if>
            <if test="streamCheckoff != null">
                #{streamCheckoff,jdbcType=CHAR},
            </if>
            <if test="subjectCheckoff != null">
                #{subjectCheckoff,jdbcType=CHAR},
            </if>
            <if test="feeCheckoff != null">
                #{feeCheckoff,jdbcType=CHAR},
            </if>
            <if test="allCheckoff != null">
                #{allCheckoff,jdbcType=CHAR},
            </if>
            <if test="checkWorker != null">
                #{checkWorker,jdbcType=VARCHAR},
            </if>
            <if test="forceReason != null">
                #{forceReason,jdbcType=VARCHAR},
            </if>
            <if test="forceFlag != null">
                #{forceFlag,jdbcType=VARCHAR},
            </if>
            <if test="checkDate != null">
                #{checkDate,jdbcType=CHAR},
            </if>
            <if test="archiveDate != null">
                #{archiveDate,jdbcType=CHAR},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.sunyard.ars.file.pojo.oa.CheckOff">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update FL_CHECKOFF_TB
        <set>
            <if test="cityNo != null">
                CITY_NO = #{cityNo,jdbcType=VARCHAR},
            </if>
            <if test="streamCheckoff != null">
                STREAM_CHECKOFF = #{streamCheckoff,jdbcType=CHAR},
            </if>
            <if test="subjectCheckoff != null">
                SUBJECT_CHECKOFF = #{subjectCheckoff,jdbcType=CHAR},
            </if>
            <if test="feeCheckoff != null">
                FEE_CHECKOFF = #{feeCheckoff,jdbcType=CHAR},
            </if>
            <if test="allCheckoff != null">
                ALL_CHECKOFF = #{allCheckoff,jdbcType=CHAR},
            </if>
            <if test="checkWorker != null">
                CHECK_WORKER = #{checkWorker,jdbcType=VARCHAR},
            </if>
            <if test="forceReason != null">
                FORCE_REASON = #{forceReason,jdbcType=VARCHAR},
            </if>
            <if test="forceFlag != null">
                FORCE_FLAG = #{forceFlag,jdbcType=VARCHAR},
            </if>
            <if test="checkDate != null">
                CHECK_DATE = #{checkDate,jdbcType=CHAR},
            </if>
            <if test="archiveDate != null">
                ARCHIVE_DATE = #{archiveDate,jdbcType=CHAR},
            </if>
        </set>
        where OCCUR_DATE = #{occurDate,jdbcType=VARCHAR}
        and SITE_NO = #{siteNo,jdbcType=VARCHAR}
        and OPERATOR_NO = #{operatorNo,jdbcType=VARCHAR}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.sunyard.ars.file.pojo.oa.CheckOff">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update FL_CHECKOFF_TB
        set CITY_NO = #{cityNo,jdbcType=VARCHAR},
        STREAM_CHECKOFF = #{streamCheckoff,jdbcType=CHAR},
        SUBJECT_CHECKOFF = #{subjectCheckoff,jdbcType=CHAR},
        FEE_CHECKOFF = #{feeCheckoff,jdbcType=CHAR},
        ALL_CHECKOFF = #{allCheckoff,jdbcType=CHAR},
        CHECK_WORKER = #{checkWorker,jdbcType=VARCHAR},
        FORCE_REASON = #{forceReason,jdbcType=VARCHAR},
        FORCE_FLAG = #{forceFlag,jdbcType=VARCHAR},
        CHECK_DATE = #{checkDate,jdbcType=CHAR},
        ARCHIVE_DATE = #{archiveDate,jdbcType=CHAR}
        where OCCUR_DATE = #{occurDate,jdbcType=VARCHAR}
        and SITE_NO = #{siteNo,jdbcType=VARCHAR}
        and OPERATOR_NO = #{operatorNo,jdbcType=VARCHAR}
    </update>

    <select id="ifRollFlow" resultType="java.util.HashMap">
        SELECT ALL_CHECKOFF FROM FL_CHECKOFF_TB  WHERE OCCUR_DATE =#{occurDate} AND SITE_NO=#{siteNo} AND OPERATOR_NO=#{operatorNo}
    </select>

    <select id="getCheckOffState" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT ALL_CHECKOFF FROM FL_CHECKOFF_TB  WHERE OPERATOR_NO=#{operatorNo,jdbcType=VARCHAR} AND SITE_NO=#{siteNo,jdbcType=VARCHAR} AND OCCUR_DATE =#{occurDate,jdbcType=VARCHAR}
    </select>

    <select id="getCheckOffDate" resultType="java.util.HashMap">
        SELECT DISTINCT T.OCCUR_DATE  FROM FL_CHECKOFF_TB T
        WHERE T.ALL_CHECKOFF = '0'
        <if test="siteNos != null">
            AND T.SITE_NO IN
            <foreach collection="siteNos" item="siteNo" open="(" separator="," close=")">
                #{siteNo}
            </foreach>
        </if>
        ORDER BY T.OCCUR_DATE DESC
    </select>

    <select id="getArchiveDate" resultType="java.util.HashMap">
        select t.OCCUR_DATE,t.SITE_NO,nvl(fc.fccount,0) CHECK_STATE from
        (
        SELECT OCCUR_DATE, SITE_NO FROM FL_CHECKOFF_TB
        GROUP BY OCCUR_DATE,SITE_NO
        ) t
        left join
        (
        select  ft.OCCUR_DATE, ft.SITE_NO,count(1) fccount from FL_CHECKOFF_TB ft
        where ft.all_checkoff &lt; '1'
        GROUP BY ft.OCCUR_DATE,ft.SITE_NO
        ) fc
        on t.OCCUR_DATE=fc.OCCUR_DATE and t.site_no=fc.site_no WHERE
        t.SITE_NO  =#{siteNo,jdbcType=VARCHAR}
    </select>

    <select id="getAllArchivedDate" resultType="java.util.HashMap">
        select t.OCCUR_DATE,t.SITE_NO,nvl(fc.fccount,0) CHECK_STATE from
        (
        SELECT OCCUR_DATE, SITE_NO FROM FL_CHECKOFF_TB
        GROUP BY OCCUR_DATE,SITE_NO
        ) t
        left join
        (
        select  ft.OCCUR_DATE, ft.SITE_NO,count(1) fccount from FL_CHECKOFF_TB ft
        where ft.all_checkoff &lt; '2'
        GROUP BY ft.OCCUR_DATE,ft.SITE_NO
        ) fc
        on t.OCCUR_DATE=fc.OCCUR_DATE and t.site_no=fc.site_no WHERE
        t.SITE_NO  =#{siteNo,jdbcType=VARCHAR}
    </select>

    <select id="getRollInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT DISTINCT B.SITE_NO, A.ORGAN_NAME, A.PARENT_ORGAN, A.ORGAN_LEVEL, B.OPERATOR_NO, B.TELLER_NAME,B.ALL_CHECKOFF,B.FORCE_FLAG,
        (SELECT COUNT(1) FROM BP_TMPBATCH_TB TB WHERE TB.OPERATOR_NO = B.OPERATOR_NO AND TB.SITE_NO = B.SITE_NO AND TB.NEED_PROCESS = '1' AND TB.IS_INVALID = '1' AND TB.OCCUR_DATE = B.OCCUR_DATE) AS BAT_COUNT
        FROM SM_ORGAN_TB A RIGHT JOIN (SELECT T1.SITE_NO,T1.OPERATOR_NO,T2.TELLER_NAME,T1.ALL_CHECKOFF,T1.FORCE_FLAG,T1.OCCUR_DATE FROM FL_CHECKOFF_TB T1 LEFT JOIN SM_TELLER_TB T2
        ON T1.OPERATOR_NO = T2.TELLER_NO WHERE T1.ALL_CHECKOFF = '0' AND
        <foreach collection="siteNoList" item="siteNos" open="(" separator="OR" close=")">
            T1.SITE_NO IN
            <foreach collection="siteNos" item="siteNo" open="(" separator="," close=")">
                #{siteNo}
            </foreach>
        </foreach>
        AND T1.OCCUR_DATE  =#{occurDate,jdbcType=VARCHAR}) B ON A.ORGAN_NO = B.SITE_NO  ORDER BY B.SITE_NO, B.OPERATOR_NO
    </select>

    <select id="getArchiveRollInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT T.TELLER_NAME,T.TELLER_NO FROM SM_TELLER_TB T WHERE T.TELLER_NO IN ( SELECT F.OPERATOR_NO FROM FL_CHECKOFF_TB F
        where  ALL_CHECKOFF = '1' AND
        <foreach collection="siteNoList" item="siteNos" open="(" separator="OR" close=")">
            F.SITE_NO IN
            <foreach collection="siteNos" item="siteNo" open="(" separator="," close=")">
                #{siteNo}
            </foreach>
        </foreach>
        AND
        <foreach collection="occurDateList" item="occurDates" open="(" separator="OR" close=")">
            F.OCCUR_DATE IN
            <foreach collection="occurDates" item="occurDate" open="(" separator="," close=")">
                #{occurDate}
            </foreach>
        </foreach>
        )
    </select>

    <select id="getOrganArchiveInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT
        <include refid="Base_Column_List" />
        from FL_CHECKOFF_TB
        <where>
            <if test="siteNos != null">
                and SITE_NO IN
                <foreach collection="siteNos" item="siteNo" open="(" separator="," close=")">
                    #{siteNo}
                </foreach>
            </if>
            <if test="occurDates != null">
                and OCCUR_DATE IN
                <foreach collection="occurDates" item="occurDate" open="(" separator="," close=")">
                    #{occurDate}
                </foreach>
            </if>
        </where>
    </select>

    <select id="getArchiveInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        select t.occur_date,t.site_no,nvl(fc.fccount,0) CHECK_STATE from
        (
        SELECT OCCUR_DATE, SITE_NO FROM FL_CHECKOFF_TB
        GROUP BY OCCUR_DATE,SITE_NO
        ) t
        left join
        (
        select  ft.OCCUR_DATE, ft.SITE_NO,count(1) fccount from FL_CHECKOFF_TB ft
        where ft.all_checkoff != '2'
        GROUP BY ft.OCCUR_DATE,ft.SITE_NO
        ) fc
        on t.OCCUR_DATE=fc.OCCUR_DATE and t.site_no=fc.site_no WHERE
        t.SITE_NO IN
        <foreach collection="siteNos" item="siteNo" open="(" separator="," close=")">
            #{siteNo}
        </foreach>
        AND t.OCCUR_DATE   &lt;=  #{occurDatee,jdbcType=VARCHAR}  AND t.OCCUR_DATE  &gt;=  #{occurDates,jdbcType=VARCHAR}
    </select>


    <update id="updateCheckoffArchive">
        UPDATE FL_CHECKOFF_TB SET ALL_CHECKOFF = '2',ARCHIVE_DATE =#{archiveDate,jdbcType=VARCHAR}
        <where>
            <if test="operatorNo != null and operatorNo != ''">
                and OPERATOR_NO =#{operatorNo,jdbcType=VARCHAR}
            </if>
            <if test="siteNo != null and siteNo != ''">
                and site_no=#{siteNo,jdbcType=VARCHAR}
            </if>
            <if test="occurDate != null and occurDate != ''">
                and occur_date=#{occurDate,jdbcType=VARCHAR}
            </if>
        </where>
    </update>

    <update id="checkUnLock">
        UPDATE FL_CHECKOFF_TB SET DATA_LOCK = 0
        <where>
            <if test="operatorNo != null and operatorNo != ''">
                and OPERATOR_NO =#{operatorNo,jdbcType=VARCHAR}
            </if>
            <if test="siteNo != null and siteNo != ''">
                and site_no=#{siteNo,jdbcType=VARCHAR}
            </if>
            <if test="occurDate != null and occurDate != ''">
                and occur_date=#{occurDate,jdbcType=VARCHAR}
            </if>
        </where>
        AND DATA_LOCK = 1
    </update>

    <update id="checkOnLock">
        UPDATE FL_CHECKOFF_TB SET DATA_LOCK = 1
        <where>
            <if test="operatorNo != null and operatorNo != ''">
                and OPERATOR_NO =#{operatorNo,jdbcType=VARCHAR}
            </if>
            <if test="siteNo != null and siteNo != ''">
                and site_no=#{siteNo,jdbcType=VARCHAR}
            </if>
            <if test="occurDate != null and occurDate != ''">
                and occur_date=#{occurDate,jdbcType=VARCHAR}
            </if>
        </where>
        AND DATA_LOCK = 0
    </update>

    <select id="getArchiveCheckoff" parameterType="java.util.HashMap" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from FL_CHECKOFF_TB
        <where>
            <if test="operatorNo != null">
                AND OPERATOR_NO = #{operatorNo,jdbcType=VARCHAR}
            </if>
            <if test="siteNo != null">
                AND SITE_NO = #{siteNo,jdbcType=VARCHAR}
            </if>
            <if test="occurDate != null">
                AND OCCUR_DATE = #{occurDate,jdbcType=VARCHAR}
            </if>
            AND ALL_CHECKOFF = '1'
        </where>

    </select>

    <delete id="deleteArchiveCheckOffData" parameterType="java.util.HashMap">
        DELETE FROM FL_CHECKOFF_TB
        <where>
            <if test="operatorNo != null">
                AND OPERATOR_NO = #{operatorNo,jdbcType=VARCHAR}
            </if>
            <if test="siteNo != null">
                AND SITE_NO = #{siteNo,jdbcType=VARCHAR}
            </if>
            <if test="occurDate != null">
                AND OCCUR_DATE = #{occurDate,jdbcType=VARCHAR}
            </if>
        </where>

    </delete>

    <select id="getSiteNoByOper" parameterType="java.util.HashMap"
            resultType="java.util.HashMap">
        SELECT TELLER_NO AS "VALUE",TELLER_NO || '-' || TELLER_NAME AS
        "NAME",T1.PARENT_ORGAN AS "INFOS",T3.ORGAN_NAME AS "ORGANNAME"
        FROM SM_TELLER_TB T1
        LEFT JOIN
        <if test="hasPrivOrganFlag != 0">
            SM_USER_ORGAN_TB
        </if>
        <if test="hasPrivOrganFlag == 0">
            (select sopt.organ_no
            from sm_organ_tb sot, sm_organ_parent_tb sopt
            where
            exists (select 1
            from sm_users_tb sut
            where
            <if test="userNo != null and userNo != ''">
                sut.user_no = #{userNo,jdbcType=VARCHAR}
            </if>
            and sot.organ_no = sut.organ_no)
            and sot.organ_no = sopt.parent_organ)
        </if>
        T2 ON T1.PARENT_ORGAN=T2.ORGAN_NO
        LEFT JOIN SM_ORGAN_TB T3 ON T3.ORGAN_NO=T2.ORGAN_NO
        <where>
            <if test="userNo != null and userNo != '' and hasPrivOrganFlag != 0">
                T2.USER_NO=#{userNo,jdbcType=VARCHAR}
            </if>
            <if test="hasPrivOrganFlag == 0">
                T2.ORGAN_NO is not null
            </if>
            <if test="operatorNo != null and operatorNo != ''">
                AND T1.TELLER_NO=#{operatorNo,jdbcType=VARCHAR}
            </if>
        </where>
        AND T1.TELLER_STATE='1' ORDER BY T1.PARENT_ORGAN
    </select>


    <select id="getArchivedDate" parameterType="java.util.HashMap" resultType="java.util.HashMap" >
        select max(ARCHIVE_DATE) MAXDATE from fl_checkoff_tb
        where OCCUR_DATE = #{occurDate,jdbcType=VARCHAR}
        and SITE_NO = #{siteNo,jdbcType=VARCHAR}
    </select>

    <!-- 正常轧账 图像流水必须处理完 -->
    <update id="updateNormalAutoCheckoff">
        UPDATE FL_CHECKOFF_TB C SET
        C.ALL_CHECKOFF = 1, CHECK_WORKER = #{checkWorker},CHECK_DATE = TO_CHAR(SYSDATE, 'YYYYMMDD')
        WHERE NOT EXISTS (SELECT 1
        FROM BP_TMPBATCH_TB T
        WHERE T.IS_INVALID = 1
        AND T.BATCH_COMMIT = 1
        AND T.NEED_PROCESS = 1
        AND T.PROGRESS_FLAG &lt; '98'
        AND T.OCCUR_DATE = C.OCCUR_DATE
        AND T.SITE_NO = C.SITE_NO
        AND T.OPERATOR_NO = C.OPERATOR_NO)
        AND NOT EXISTS (SELECT 1
        FROM BP_TMPBATCH_TB G
        JOIN BP_TMPDATA_1_TB H
        ON G.BATCH_ID = H.BATCH_ID
        WHERE G.IS_INVALID = 1
        AND G.NEED_PROCESS = 1
        AND G.BATCH_COMMIT = 1
        AND H.CHECK_FLAG = '-1'
        AND G.OCCUR_DATE = C.OCCUR_DATE
        AND G.SITE_NO = C.SITE_NO
        AND G.OPERATOR_NO = C.OPERATOR_NO)
        AND NOT EXISTS (SELECT 1
        FROM FL_FLOW_TB K
        WHERE K.CHECK_FLAG = '-1'
        AND K.OCCUR_DATE = C.OCCUR_DATE
        AND K.SITE_NO = C.SITE_NO
        AND K.OPERATOR_NO = C.OPERATOR_NO)
        AND EXISTS (SELECT 1
        FROM BP_TMPBATCH_TB T
        WHERE T.IS_INVALID = 1
        AND T.BATCH_COMMIT = 1
        AND T.OCCUR_DATE = C.OCCUR_DATE
        AND T.SITE_NO = C.SITE_NO
        AND T.OPERATOR_NO = C.OPERATOR_NO)
        AND C.ALL_CHECKOFF = '0'
        AND C.OCCUR_DATE  = #{occurDate,jdbcType=VARCHAR}
        AND C.SITE_NO = #{siteNo,jdbcType=VARCHAR}
    </update>

    <select id="getNormalAutoCheckoff"  parameterType="java.util.HashMap" resultType="java.util.HashMap">
        select C.OCCUR_DATE,C.OPERATOR_NO,C.SITE_NO
        FROM FL_CHECKOFF_TB C
        WHERE NOT EXISTS (SELECT 1
        FROM BP_TMPBATCH_TB T
        WHERE T.IS_INVALID = 1
        AND T.BATCH_COMMIT = 1
        AND T.NEED_PROCESS = 1
        AND T.PROGRESS_FLAG &lt; '98'
        AND T.OCCUR_DATE = C.OCCUR_DATE
        AND T.SITE_NO = C.SITE_NO
        AND T.OPERATOR_NO = C.OPERATOR_NO)
        AND NOT EXISTS (SELECT 1
        FROM BP_TMPBATCH_TB G
        JOIN BP_TMPDATA_1_TB H
        ON G.BATCH_ID = H.BATCH_ID
        WHERE G.IS_INVALID = 1
        AND G.NEED_PROCESS = 1
        AND G.BATCH_COMMIT = 1
        AND H.CHECK_FLAG = '-1'
        AND G.OCCUR_DATE = C.OCCUR_DATE
        AND G.SITE_NO = C.SITE_NO
        AND G.OPERATOR_NO = C.OPERATOR_NO)
        AND NOT EXISTS (SELECT 1
        FROM FL_FLOW_TB K
        WHERE K.CHECK_FLAG = '-1'
        AND K.OCCUR_DATE = C.OCCUR_DATE
        AND K.SITE_NO = C.SITE_NO
        AND K.OPERATOR_NO = C.OPERATOR_NO)
        AND EXISTS (SELECT 1
        FROM BP_TMPBATCH_TB T
        WHERE T.IS_INVALID = 1
        AND T.BATCH_COMMIT = 1
        AND T.OCCUR_DATE = C.OCCUR_DATE
        AND T.SITE_NO = C.SITE_NO
        AND T.OPERATOR_NO = C.OPERATOR_NO)
        AND C.ALL_CHECKOFF = '0'
        AND C.OCCUR_DATE  = #{occurDate,jdbcType=VARCHAR}
        AND C.SITE_NO = #{siteNo,jdbcType=VARCHAR}
    </select>

    <select id="getUncheckCheckoff" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        select F.OCCUR_DATE,F.OPERATOR_NO,F.SITE_NO
        from FL_CHECKOFF_TB F
        <where>
            <if test="operatorNo != null">
                AND F.OPERATOR_NO = #{operatorNo,jdbcType=VARCHAR}
            </if>
            <if test="siteNos != null">
                AND F.SITE_NO IN
                <foreach collection="siteNos" item="siteNo" open="(" separator="," close=")">
                    #{siteNo}
                </foreach>
            </if>
            <if test="occurDate != null">
                AND F.OCCUR_DATE = #{occurDate,jdbcType=VARCHAR}
            </if>
            AND ALL_CHECKOFF = '0' ORDER BY F.SITE_NO,F.OPERATOR_NO
        </where>
    </select>


    <update id="updateForceSelective"  parameterType="java.util.HashMap">
        update FL_CHECKOFF_TB
        <set>
            <if test="allCheckoff != null">
                ALL_CHECKOFF = #{allCheckoff,jdbcType=CHAR},
            </if>
            <if test="checkWorker != null">
                CHECK_WORKER = #{checkWorker,jdbcType=VARCHAR},
            </if>
            <if test="forceReason != null">
                FORCE_REASON = #{forceReason,jdbcType=VARCHAR},
            </if>
            <if test="forceFlag != null">
                FORCE_FLAG = #{forceFlag,jdbcType=VARCHAR},
            </if>
            <if test="checkDate != null">
                CHECK_DATE = #{checkDate,jdbcType=CHAR},
            </if>
            <if test="empLogId != null and empLogId != ''">
                EMPLOG_ID = #{empLogId,jdbcType=CHAR},
            </if>
        </set>
        where OCCUR_DATE = #{occurDate,jdbcType=VARCHAR}
        and SITE_NO = #{siteNo,jdbcType=VARCHAR}
        and OPERATOR_NO = #{operatorNo,jdbcType=VARCHAR}
    </update>
</mapper>