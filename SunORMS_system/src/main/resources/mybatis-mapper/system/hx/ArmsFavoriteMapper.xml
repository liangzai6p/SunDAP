<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunyard.ars.system.dao.hx.ArmsFavoriteMapper">
  <resultMap id="BaseResultMap" type="com.sunyard.ars.system.bean.hx.ArmsFavorite">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <result column="ID" jdbcType="VARCHAR" property="id" />
    <result column="TYPE" jdbcType="VARCHAR" property="type" />
    <result column="ENTRY_ID" jdbcType="VARCHAR" property="entryId" />
    <result column="ENTRYROW_ID" jdbcType="VARCHAR" property="entryrowId" />
    <result column="FORM_ID" jdbcType="VARCHAR" property="formId" />
    <result column="FAVORITE_TITLE" jdbcType="VARCHAR" property="favoriteTitle" />
    <result column="FAVORITE_TIME" jdbcType="TIMESTAMP" property="favoriteTime" />
    <result column="FAVORITE_USER" jdbcType="VARCHAR" property="favoriteUser" />
    <result column="FAVORITE_ORGAN" jdbcType="VARCHAR" property="favoriteOrgan" />
    <result column="REMARK" jdbcType="VARCHAR" property="remark" />
    <result column="REMARK_COMMON" jdbcType="VARCHAR" property="remarkCommon" />
    <result column="ISCOMMON" jdbcType="VARCHAR" property="iscommon" />
  </resultMap>
  <insert id="insert" parameterType="com.sunyard.ars.system.bean.hx.ArmsFavorite">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into ARMS_FAVORITE_TB (ID, TYPE, ENTRY_ID, 
      ENTRYROW_ID, FORM_ID, FAVORITE_TITLE, 
      FAVORITE_TIME, FAVORITE_USER, FAVORITE_ORGAN, 
      REMARK, REMARK_COMMON, ISCOMMON
      )
    values (#{id,jdbcType=VARCHAR}, #{type,jdbcType=VARCHAR}, #{entryId,jdbcType=VARCHAR}, 
      #{entryrowId,jdbcType=VARCHAR}, #{formId,jdbcType=VARCHAR}, #{favoriteTitle,jdbcType=VARCHAR}, 
      #{favoriteTime,jdbcType=TIMESTAMP}, #{favoriteUser,jdbcType=VARCHAR}, #{favoriteOrgan,jdbcType=VARCHAR}, 
      #{remark,jdbcType=VARCHAR}, #{remarkCommon,jdbcType=VARCHAR}, #{iscommon,jdbcType=VARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.sunyard.ars.system.bean.hx.ArmsFavorite">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into ARMS_FAVORITE_TB
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        ID,
      </if>
      <if test="type != null">
        TYPE,
      </if>
      <if test="entryId != null">
        ENTRY_ID,
      </if>
      <if test="entryrowId != null">
        ENTRYROW_ID,
      </if>
      <if test="formId != null">
        FORM_ID,
      </if>
      <if test="favoriteTitle != null">
        FAVORITE_TITLE,
      </if>
      <if test="favoriteTime != null">
        FAVORITE_TIME,
      </if>
      <if test="favoriteUser != null">
        FAVORITE_USER,
      </if>
      <if test="favoriteOrgan != null">
        FAVORITE_ORGAN,
      </if>
      <if test="remark != null">
        REMARK,
      </if>
      <if test="remarkCommon != null">
        REMARK_COMMON,
      </if>
      <if test="iscommon != null">
        ISCOMMON,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="type != null">
        #{type,jdbcType=VARCHAR},
      </if>
      <if test="entryId != null">
        #{entryId,jdbcType=VARCHAR},
      </if>
      <if test="entryrowId != null">
        #{entryrowId,jdbcType=VARCHAR},
      </if>
      <if test="formId != null">
        #{formId,jdbcType=VARCHAR},
      </if>
      <if test="favoriteTitle != null">
        #{favoriteTitle,jdbcType=VARCHAR},
      </if>
      <if test="favoriteTime != null">
        #{favoriteTime,jdbcType=TIMESTAMP},
      </if>
      <if test="favoriteUser != null">
        #{favoriteUser,jdbcType=VARCHAR},
      </if>
      <if test="favoriteOrgan != null">
        #{favoriteOrgan,jdbcType=VARCHAR},
      </if>
      <if test="remark != null">
        #{remark,jdbcType=VARCHAR},
      </if>
      <if test="remarkCommon != null">
        #{remarkCommon,jdbcType=VARCHAR},
      </if>
      <if test="iscommon != null">
        #{iscommon,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <delete id="deleteByKey" parameterType="string" >
    DELETE FROM ARMS_FAVORITE_TB T WHERE T.FAVORITE_USER = #{userNo} AND T.ID IN (#{id}) 
  </delete>
  
  <select id="getAlarmInfoList" parameterType="java.util.HashMap" resultType="map">
    <choose>
        <when test="dbType == @com.sunyard.ars.common.comm.ARSConstants@DATABASE_TYPE_DB2">
            SELECT ROW_NUMBER() OVER() SEQ, ENTRY_ID, NAME, to_char(FAVORITE_TIME,'yyyy-MM-dd') FAVORITE_TIME,NUM
            FROM (
                SELECT AFT.ENTRY_ID,
                MMT.NAME,
                MAX(AFT.FAVORITE_TIME) FAVORITE_TIME,
                count(1) num
                FROM ARMS_FAVORITE_TB AFT
                JOIN MC_MODEL_TB MMT
                 ON AFT.ENTRY_ID = MMT.ID
            <where>
                <if test="organNo !=null and organNo !='' and organNo!=9999">
                    and (instr((select t.ORGAN_NO from SM_ORGAN_TB t where t.ORGAN_NO=#{organNo}),AFT.FAVORITE_ORGAN)>0 OR AFT.ISCOMMON='1')
                </if>
                <if test="modelName!=null and modelName!='' ">
                    AND  MMT.NAME like '%'||#{modelName}||'%'
                </if>
                <if test="startAddTime != null and startAddTime != ''">
                    AND to_char(AFT.FAVORITE_TIME,'yyyy-MM-dd') <![CDATA[>=]]> #{startAddTime}
                </if>
                <if test="endAddTime != null and endAddTime != ''">
                    AND to_char(AFT.FAVORITE_TIME,'yyyy-MM-dd') <![CDATA[<=]]> #{endAddTime}
                </if>
                and AFT.TYPE = '0'
            </where>
            GROUP BY AFT.ENTRY_ID, MMT.NAME
            ORDER BY FAVORITE_TIME)
        </when>
        <otherwise>
            SELECT ROWNUM SEQ, ENTRY_ID, NAME, to_char(FAVORITE_TIME,'yyyy-MM-dd') FAVORITE_TIME,NUM
                  FROM (SELECT AFT.ENTRY_ID,
                               MMT.NAME,
                               MAX(AFT.FAVORITE_TIME) FAVORITE_TIME,
                               count(1) num
                          FROM ARMS_FAVORITE_TB AFT
                          JOIN MC_MODEL_TB MMT
                            ON AFT.ENTRY_ID = MMT.ID
                 <where>
                    <if test="organNo !=null and organNo !='' and organNo!=9999">
                        and (instr((select t.ORGAN_NO from SM_ORGAN_TB t where t.ORGAN_NO=#{organNo}),AFT.FAVORITE_ORGAN)>0 OR AFT.ISCOMMON='1')
                    </if>
                    <if test="modelName!=null and modelName!='' ">
                        AND  MMT.NAME like '%'||#{modelName}||'%'
                    </if>
                    <if test="startAddTime != null and startAddTime != ''">
                        AND to_char(AFT.FAVORITE_TIME,'yyyy-MM-dd') <![CDATA[>=]]> #{startAddTime}
                    </if>
                    <if test="endAddTime != null and endAddTime != ''">
                        AND to_char(AFT.FAVORITE_TIME,'yyyy-MM-dd') <![CDATA[<=]]> #{endAddTime}
                    </if>
                    and AFT.TYPE = '0'
                 </where>
                 GROUP BY AFT.ENTRY_ID, MMT.NAME
                 ORDER BY FAVORITE_TIME)
        </otherwise>
    </choose>
  </select>
  
  <select id="getAlarmInfoDetailList" parameterType="java.util.HashMap" resultType="map">
  	 SELECT ${queryStr},T1.ID,T1.FAVORITE_TITLE,T1.ENTRY_ID,T1.ENTRYROW_ID,T1.REMARK REMARK_MANUAL,
	       T1.REMARK_COMMON,T1.ISCOMMON,T1.FAVORITE_USER,T1.FAVORITE_ORGAN,T2.MONITORID
	  FROM ARMS_FAVORITE_TB T1
	  LEFT JOIN (select * from ${tableName} union all select * from ${tableName}_HIS) T2
	    ON T1.ENTRY_ID = T2.ENTRY_ID
	   AND T1.ENTRYROW_ID = T2.ENTRYROW_ID
	 <where>
	 	<if test="organNo != null and organNo !='' and organNo != 9999">
         	AND (T1.FAVORITE_ORGAN = #{organNo} OR T1.ISCOMMON = '1')
        </if>
	    <if test="startAddTime != null and startAddTime != ''">
			AND to_char(T1.FAVORITE_TIME,'yyyy-MM-dd') <![CDATA[>=]]> #{startAddTime}
		</if>
		<if test="endAddTime != null and endAddTime != ''">
		    AND to_char(T1.FAVORITE_TIME,'yyyy-MM-dd') <![CDATA[<=]]> #{endAddTime}
		</if>
	    AND T1.ENTRY_ID = #{entryId}
	    AND T1.TYPE = '0'
	 </where>
	 ORDER BY T2.HANDLE_ORGAN,
	          T2.BANKCODE,
	          T2.CREATE_DATE  DESC,
	          T2.ENTRYROW_ID  DESC       
  </select>
  
  <delete id="deleteFavorite" parameterType="java.util.HashMap" >
    DELETE FROM ARMS_FAVORITE_TB T WHERE T.FAVORITE_USER = #{favoriteUser,jdbcType=VARCHAR}
    AND T.ID IN 
    <foreach collection="deleteList" item="deleteId" open="(" close=")" separator="," >
		#{deleteId,jdbcType=VARCHAR}
	</foreach>
    AND T.TYPE = #{favoriteType,jdbcType=VARCHAR}
  </delete>
  
  <update id="setCommon" parameterType="java.util.HashMap" >
    UPDATE ARMS_FAVORITE_TB SET REMARK_COMMON=#{commonRemark,jdbcType=VARCHAR},ISCOMMON='1' WHERE ID IN 
    <foreach collection="commSetList" item="commSetId" open="(" close=")" separator="," >
		#{commSetId,jdbcType=VARCHAR}
	</foreach>
  </update>
  
  <!--  联合案例库表和差错信息表做查询 -->
  <select id="getAlarmBillData" parameterType="map" resultType="map">
	SELECT T1.ID,
	T1.FAVORITE_USER,
	to_char(T1.FAVORITE_TIME,'yyyy-MM-dd') FAVORITE_TIME,
	T1.FORM_ID FORM_ID_1,
	T1.REMARK,
	T1.REMARK_COMMON,
	T1.ISCOMMON,
	T1.FAVORITE_ORGAN,
	T2.FORM_TYPE,
	T2.FORM_ID FORM_ID_2,
	T2.ENTRY_NAME,
	T2.ALARM_LEVEL,
	T2.BUSI_NO_CT,
	T2.NET_NO,
	T2.NET_NAME,
	T2.ALARM_CREATE_TIME,
	T2.XF_DATE,
	T2.BACK_DATE,
	T2.END_DATE,
	(SELECT USER_NAME FROM SM_USERS_TB WHERE USER_NO = T2.CHECKER_NO) CHECKER_NO,
	T2.FORM_STATE,
	T2.SOURCE_FLAG
	FROM ARMS_FAVORITE_TB T1
	LEFT JOIN ET_BUSIFORM_TB T2
	ON T1.FORM_ID = T2.FORM_ID
	<where>
		<if	test="currentOrganNo !=null and currentOrganNo !='' and currentOrganNo !=9999">
			AND	(INSTR((SELECT t.ORGAN_NO FROM SM_ORGAN_TB t where
				t.ORGAN_NO=#{currentOrganNo}),T1.FAVORITE_ORGAN)>0 OR T1.ISCOMMON='1')
		</if>
		<if test="queryOrganNo !=null and queryOrganNo !=''">
		    AND T2.NET_NO in (SELECT Organ_no FROM sm_organ_parent_tb WHERE parent_Organ=#{queryOrganNo})  
		</if>
		<if test="inStoreTimeStart!=null and inStoreTimeStart!=''">
			AND to_char(T1.FAVORITE_TIME,'yyyy-MM-dd') <![CDATA[>=]]> #{inStoreTimeStart}
		</if>
		<if test="inStoreTimeEnd !=null and inStoreTimeEnd !=''">
			AND to_char(T1.FAVORITE_TIME,'yyyy-MM-dd') <![CDATA[<=]]> #{inStoreTimeEnd}
		</if>
		
		<!-- 预警单编号 模糊 -->
		<if test="FORM_ID !=null and FORM_ID !=''">
			AND T1.FORM_ID like CONCAT('%',CONCAT(#{FORM_ID},'%'))
		</if>
				
		<if test="FAVORITE_USER !=null and FAVORITE_USER !=''">
			AND T1.FAVORITE_USER = #{FAVORITE_USER}
		</if>
		
		<if test="T3_ORGAN_NO !=null and T3_ORGAN_NO !=''">
			AND T1.FAVORITE_ORGAN = #{T3_ORGAN_NO}
		</if>
		
		<if test="ENTRY_NAME !=null and ENTRY_NAME !=''">
			AND T2.ENTRY_NAME like CONCAT('%',CONCAT(#{ENTRY_NAME},'%'))
		</if>
		
		<if test="BUSI_NO_CT !=null and BUSI_NO_CT !=''">
			AND T2.BUSI_NO_CT = #{BUSI_NO_CT}
		</if>
		
		<if test="FORM_TYPE !=null and FORM_TYPE !=''">
			AND T2.FORM_TYPE = #{FORM_TYPE}
		</if>
		
		<if test="XF_DATE_START !=null and XF_DATE_START!=''">
			AND  T2.XF_DATE <![CDATA[>=]]> #{XF_DATE_START}
		</if>
		
		<if test="XF_DATE_END !=null and XF_DATE_END !=''">
			AND  T2.XF_DATE <![CDATA[<=]]> #{XF_DATE_END}
		</if>
		AND T1.TYPE = '1'
		AND TRIM(T1.FORM_ID) <![CDATA[ <> ]]>  ' '
	</where>
    
  <!-- ORDER BY T1.FAVORITE_TIME DESC -->
      <!-- 按照 警报级别 名称 时间 排序-->
      ORDER BY T2.ALARM_LEVEL, T2.ENTRY_NAME, T1.FAVORITE_TIME DESC

  </select>
</mapper>