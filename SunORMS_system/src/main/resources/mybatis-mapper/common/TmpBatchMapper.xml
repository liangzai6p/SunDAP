<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sunyard.ars.common.dao.TmpBatchMapper">
  <resultMap id="BaseResultMap" type="com.sunyard.ars.common.pojo.TmpBatch">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="BATCH_ID" jdbcType="CHAR" property="batchId" />
    <result column="BATCH_LOCK" jdbcType="CHAR" property="batchLock" />
    <result column="BATCH_TOTAL_PAGE" jdbcType="VARCHAR" property="batchTotalPage" />
    <result column="BUSINESS_ID" jdbcType="DECIMAL" property="businessId" />
    <result column="BATCH_COMMIT" jdbcType="CHAR" property="batchCommit" />
    <result column="INPUT_DATE" jdbcType="CHAR" property="inputDate" />
    <result column="TEMP_DATA_TABLE" jdbcType="VARCHAR" property="tempDataTable" />
    <result column="INPUT_WORKER" jdbcType="VARCHAR" property="inputWorker" />
    <result column="MACHINE_ID" jdbcType="VARCHAR" property="machineId" />
    <result column="NEED_PROCESS" jdbcType="CHAR" property="needProcess" />
    <result column="OCCUR_DATE" jdbcType="VARCHAR" property="occurDate" />
    <result column="OPERATOR_NO" jdbcType="VARCHAR" property="operatorNo" />
    <result column="PROGRESS_FLAG" jdbcType="CHAR" property="progressFlag" />
    <result column="SITE_NO" jdbcType="VARCHAR" property="siteNo" />
    <result column="INPUT_TIME" jdbcType="CHAR" property="inputTime" />
    <result column="IMAGE_STATUS" jdbcType="CHAR" property="imageStatus" />
    <result column="IS_INVALID" jdbcType="CHAR" property="isInvalid" />
    <result column="PRIORITY_LEVEL" jdbcType="CHAR" property="priorityLevel" />
    <result column="WORKER" jdbcType="VARCHAR" property="worker" />
    <result column="WORK_TIME" jdbcType="VARCHAR" property="workTime" />
    <result column="PROCINSTID" jdbcType="DECIMAL" property="procinstId" />
    <result column="OCR_FACTOR_FLAG" jdbcType="CHAR" property="ocrFactorFlag" />
    <result column="AREA_CODE" jdbcType="VARCHAR" property="areaCode" />
    <result column="CONTENT_ID" jdbcType="VARCHAR" property="contentId" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    BATCH_ID, BATCH_LOCK, BATCH_TOTAL_PAGE, BUSINESS_ID, BATCH_COMMIT, INPUT_DATE, TEMP_DATA_TABLE, 
    INPUT_WORKER, MACHINE_ID, NEED_PROCESS, OCCUR_DATE, OPERATOR_NO, PROGRESS_FLAG, SITE_NO, 
    INPUT_TIME, IMAGE_STATUS, IS_INVALID, PRIORITY_LEVEL, WORKER, WORK_TIME,PROCINSTID,OCR_FACTOR_FLAG,AREA_CODE,CONTENT_ID
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from BP_TMPBATCH_TB
    where BATCH_ID = #{batchId,jdbcType=CHAR}
  </select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from BP_TMPBATCH_TB
    where BATCH_ID = #{batchId,jdbcType=CHAR}
  </delete>
  <insert id="insert" parameterType="com.sunyard.ars.common.pojo.TmpBatch">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into BP_TMPBATCH_TB (BATCH_ID, BATCH_LOCK, BATCH_TOTAL_PAGE, 
      BUSINESS_ID, BATCH_COMMIT, INPUT_DATE, 
      TEMP_DATA_TABLE, INPUT_WORKER, MACHINE_ID, 
      NEED_PROCESS, OCCUR_DATE, OPERATOR_NO, 
      PROGRESS_FLAG, SITE_NO, INPUT_TIME, 
      IMAGE_STATUS, IS_INVALID, PRIORITY_LEVEL, 
      WORKER, WORK_TIME)
    values (#{batchId,jdbcType=CHAR}, #{batchLock,jdbcType=CHAR}, #{batchTotalPage,jdbcType=VARCHAR}, 
      #{businessId,jdbcType=DECIMAL}, #{batchCommit,jdbcType=CHAR}, #{inputDate,jdbcType=CHAR}, 
      #{tempDataTable,jdbcType=VARCHAR}, #{inputWorker,jdbcType=VARCHAR}, #{machineId,jdbcType=VARCHAR}, 
      #{needProcess,jdbcType=CHAR}, #{occurDate,jdbcType=VARCHAR}, #{operatorNo,jdbcType=VARCHAR}, 
      #{progressFlag,jdbcType=CHAR}, #{siteNo,jdbcType=VARCHAR}, #{inputTime,jdbcType=CHAR}, 
      #{imageStatus,jdbcType=CHAR}, #{isInvalid,jdbcType=CHAR}, #{priorityLevel,jdbcType=CHAR}, 
      #{worker,jdbcType=VARCHAR}, #{workTime,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.sunyard.ars.common.pojo.TmpBatch">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into BP_TMPBATCH_TB
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="batchId != null">
        BATCH_ID,
      </if>
      <if test="batchLock != null">
        BATCH_LOCK,
      </if>
      <if test="batchTotalPage != null">
        BATCH_TOTAL_PAGE,
      </if>
      <if test="businessId != null">
        BUSINESS_ID,
      </if>
      <if test="batchCommit != null">
        BATCH_COMMIT,
      </if>
      <if test="inputDate != null">
        INPUT_DATE,
      </if>
      <if test="tempDataTable != null">
        TEMP_DATA_TABLE,
      </if>
      <if test="inputWorker != null">
        INPUT_WORKER,
      </if>
      <if test="machineId != null">
        MACHINE_ID,
      </if>
      <if test="needProcess != null">
        NEED_PROCESS,
      </if>
      <if test="occurDate != null">
        OCCUR_DATE,
      </if>
      <if test="operatorNo != null">
        OPERATOR_NO,
      </if>
      <if test="progressFlag != null">
        PROGRESS_FLAG,
      </if>
      <if test="siteNo != null">
        SITE_NO,
      </if>
      <if test="inputTime != null">
        INPUT_TIME,
      </if>
      <if test="imageStatus != null">
        IMAGE_STATUS,
      </if>
      <if test="isInvalid != null">
        IS_INVALID,
      </if>
      <if test="priorityLevel != null">
        PRIORITY_LEVEL,
      </if>
      <if test="worker != null">
        WORKER,
      </if>
      <if test="workTime != null">
        WORK_TIME,
      </if>
        <if test="ocrFactorFlag != null">
        OCR_FACTOR_FLAG ,
      </if>
      <if test="areaCode != null">
        AREA_CODE ,
      </if>
      <if test="contentId != null">
        CONTENT_ID ,
      </if>
      
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="batchId != null">
        #{batchId,jdbcType=CHAR},
      </if>
      <if test="batchLock != null">
        #{batchLock,jdbcType=CHAR},
      </if>
      <if test="batchTotalPage != null">
        #{batchTotalPage,jdbcType=VARCHAR},
      </if>
      <if test="businessId != null">
        #{businessId,jdbcType=DECIMAL},
      </if>
      <if test="batchCommit != null">
        #{batchCommit,jdbcType=CHAR},
      </if>
      <if test="inputDate != null">
        #{inputDate,jdbcType=CHAR},
      </if>
      <if test="tempDataTable != null">
        #{tempDataTable,jdbcType=VARCHAR},
      </if>
      <if test="inputWorker != null">
        #{inputWorker,jdbcType=VARCHAR},
      </if>
      <if test="machineId != null">
        #{machineId,jdbcType=VARCHAR},
      </if>
      <if test="needProcess != null">
        #{needProcess,jdbcType=CHAR},
      </if>
      <if test="occurDate != null">
        #{occurDate,jdbcType=VARCHAR},
      </if>
      <if test="operatorNo != null">
        #{operatorNo,jdbcType=VARCHAR},
      </if>
      <if test="progressFlag != null">
        #{progressFlag,jdbcType=CHAR},
      </if>
      <if test="siteNo != null">
        #{siteNo,jdbcType=VARCHAR},
      </if>
      <if test="inputTime != null">
        #{inputTime,jdbcType=CHAR},
      </if>
      <if test="imageStatus != null">
        #{imageStatus,jdbcType=CHAR},
      </if>
      <if test="isInvalid != null">
        #{isInvalid,jdbcType=CHAR},
      </if>
      <if test="priorityLevel != null">
        #{priorityLevel,jdbcType=CHAR},
      </if>
      <if test="worker != null">
        #{worker,jdbcType=VARCHAR},
      </if>
      <if test="workTime != null">
        #{workTime,jdbcType=VARCHAR},
      </if>
       <if test="ocrFactorFlag != null">
       #{ocrFactorFlag,jdbcType=CHAR},
      </if>
       <if test="areaCode != null">
       #{areaCode,jdbcType=VARCHAR},
      </if>
       <if test="contentId != null">
        #{contentId,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.sunyard.ars.common.pojo.TmpBatch">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update BP_TMPBATCH_TB
    <set>
      <if test="batchLock != null">
        BATCH_LOCK = #{batchLock,jdbcType=CHAR},
      </if>
      <if test="batchTotalPage != null">
        BATCH_TOTAL_PAGE = #{batchTotalPage,jdbcType=VARCHAR},
      </if>
      <if test="businessId != null">
        BUSINESS_ID = #{businessId,jdbcType=DECIMAL},
      </if>
      <if test="batchCommit != null">
        BATCH_COMMIT = #{batchCommit,jdbcType=CHAR},
      </if>
      <if test="inputDate != null">
        INPUT_DATE = #{inputDate,jdbcType=CHAR},
      </if>
      <if test="tempDataTable != null">
        TEMP_DATA_TABLE = #{tempDataTable,jdbcType=VARCHAR},
      </if>
      <if test="inputWorker != null">
        INPUT_WORKER = #{inputWorker,jdbcType=VARCHAR},
      </if>
      <if test="machineId != null">
        MACHINE_ID = #{machineId,jdbcType=VARCHAR},
      </if>
      <if test="needProcess != null">
        NEED_PROCESS = #{needProcess,jdbcType=CHAR},
      </if>
      <if test="occurDate != null">
        OCCUR_DATE = #{occurDate,jdbcType=VARCHAR},
      </if>
      <if test="operatorNo != null">
        OPERATOR_NO = #{operatorNo,jdbcType=VARCHAR},
      </if>
      <if test="progressFlag != null">
        PROGRESS_FLAG = #{progressFlag,jdbcType=CHAR},
      </if>
      <if test="siteNo != null">
        SITE_NO = #{siteNo,jdbcType=VARCHAR},
      </if>
      <if test="inputTime != null">
        INPUT_TIME = #{inputTime,jdbcType=CHAR},
      </if>
      <if test="imageStatus != null">
        IMAGE_STATUS = #{imageStatus,jdbcType=CHAR},
      </if>
      <if test="isInvalid != null">
        IS_INVALID = #{isInvalid,jdbcType=CHAR},
      </if>
      <if test="priorityLevel != null">
        PRIORITY_LEVEL = #{priorityLevel,jdbcType=CHAR},
      </if>
      <if test="worker != null">
        WORKER = #{worker,jdbcType=VARCHAR},
      </if>
      <if test="workTime != null">
        WORK_TIME = #{workTime,jdbcType=VARCHAR},
      </if>
       <if test="ocrFactorFlag != null">
        OCR_FACTOR_FLAG = #{ocrFactorFlag,jdbcType=CHAR},
      </if>
      <if test="procinstId != null">
        PROCINSTID = #{procinstId,jdbcType=CHAR},
      </if>
      <if test="areaCode != null">
        AREA_CODE = #{areaCode,jdbcType=VARCHAR},
      </if>
      <if test="contentId != null">
        CONTENT_ID = #{contentId,jdbcType=VARCHAR},
      </if>
    </set>
    where BATCH_ID = #{batchId,jdbcType=CHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.sunyard.ars.common.pojo.TmpBatch">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update BP_TMPBATCH_TB
    set BATCH_LOCK = #{batchLock,jdbcType=CHAR},
      BATCH_TOTAL_PAGE = #{batchTotalPage,jdbcType=VARCHAR},
      BUSINESS_ID = #{businessId,jdbcType=DECIMAL},
      BATCH_COMMIT = #{batchCommit,jdbcType=CHAR},
      INPUT_DATE = #{inputDate,jdbcType=CHAR},
      TEMP_DATA_TABLE = #{tempDataTable,jdbcType=VARCHAR},
      INPUT_WORKER = #{inputWorker,jdbcType=VARCHAR},
      MACHINE_ID = #{machineId,jdbcType=VARCHAR},
      NEED_PROCESS = #{needProcess,jdbcType=CHAR},
      OCCUR_DATE = #{occurDate,jdbcType=VARCHAR},
      OPERATOR_NO = #{operatorNo,jdbcType=VARCHAR},
      PROGRESS_FLAG = #{progressFlag,jdbcType=CHAR},
      SITE_NO = #{siteNo,jdbcType=VARCHAR},
      INPUT_TIME = #{inputTime,jdbcType=CHAR},
      IMAGE_STATUS = #{imageStatus,jdbcType=CHAR},
      IS_INVALID = #{isInvalid,jdbcType=CHAR},
      PRIORITY_LEVEL = #{priorityLevel,jdbcType=CHAR},
      WORKER = #{worker,jdbcType=VARCHAR},
      WORK_TIME = #{workTime,jdbcType=VARCHAR},
      OCR_FACTOR_FLAG = #{ocrFactorFlag,jdbcType=CHAR},
	  AREA_CODE = #{areaCode,jdbcType=VARCHAR},
	  CONTENT_ID = #{contentId,jdbcType=VARCHAR},
    where BATCH_ID = #{batchId,jdbcType=CHAR}
  </update>
  
  <select id="getUncheckImgCount" parameterType="java.util.HashMap" resultType="java.lang.Integer">
  	SELECT COUNT(1) FROM BP_TMPDATA_1_TB t  WHERE  t.CHECK_FLAG = '-1' AND t.BATCH_ID  in ( SELECT b.batch_id from BP_TMPBATCH_TB b 
    <where>
    		b. IS_INVALID = '1' AND B.NEED_PROCESS = '1'
    	<if test="occurDate != null">
	         AND b.OCCUR_DATE = #{occurDate,jdbcType=VARCHAR}
	    </if>
	    <if test="siteNo !=null and siteNo!=''">
	         AND b.SITE_NO = #{siteNo,jdbcType=VARCHAR}
	    </if>
	    <if test="operatorNo !=null and operatorNo !=''">
	         AND b.OPERATOR_NO = #{operatorNo,jdbcType=VARCHAR}
	    </if>
    </where>
  		 )
  </select>
  
  <select id="getPatchTaskList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	
	select tt3.*,rownum as RN from (
	select tt1.*,(tt1.task_count+tt2.task_count) as task_count2 from
	(select t1.*, nvl(t2.c,0) as task_count from bp_tmpbatch_tb t1 left join
	(select batch_id,count(*) as c from bp_tmpdata_1_tb where
	substr(PROCESS_STATE,4,1)='1' group by batch_id) t2 on
	t1.batch_id=t2.batch_id
	where t1.is_invalid='1' 
	<if test="queryType == '0'.toString()">
	   and t1.input_worker=#{userNo}
	</if>
	<if test="queryType == '1'.toString()">
	    <if test="occurDate !=null and occurDate != ''">
	    and t1.occur_date = #{occurDate}
	    </if>
	    <if test="siteNo !=null and siteNo!=''">
	    and t1.site_no = #{siteNo}
	    </if>
	    <if test="operatorNo !=null and operatorNo !=''">
	    and t1.operator_no = #{operatorNo}
	    </if>
	    <if test="hasPrivOrganFlag != 0">
	    and exists (select 1 from sm_user_organ_tb t3 where t1.site_no = t3.organ_no and t3.user_no = #{userNo})
	    </if>
	    <if test="hasPrivOrganFlag == 0">
	  	AND EXISTS (select 1
		from sm_organ_tb sot, sm_organ_parent_tb sopt
		where
		exists (select 1
		from sm_users_tb sut
		where sut.user_no = #{userNo}
		and sot.organ_no = sut.organ_no)
		and sot.organ_no = sopt.parent_organ
		and sopt.organ_no=t1.site_no
		)
	    </if>
	    
	</if>	
	) tt1,
	(select t1.*, nvl(t2.c,0) as task_count from bp_tmpbatch_tb t1 left join
	(select batch_id,count(*) as c from bp_patchtask_tb where status = '0'
	group by batch_id) t2 on t1.batch_id=t2.batch_id where
	t1.is_invalid='1' 
	<if test="queryType == '0'.toString()">
	   and t1.input_worker=#{userNo}
	</if>
	<if test="queryType == '1'.toString()">
	    <if test="occurDate !=null and occurDate != ''">
	    and t1.occur_date = #{occurDate}
	    </if>
	    <if test="siteNo !=null and siteNo!=''">
	    and t1.site_no = #{siteNo}
	    </if>
	    <if test="operatorNo !=null and operatorNo !=''">
	    and t1.operator_no = #{operatorNo}
	    </if>
	    <if test="hasPrivOrganFlag != 0">
	    and exists (select 1 from sm_user_organ_tb t3 where t1.site_no = t3.organ_no and t3.user_no = #{userNo})
	    </if>
	    <if test="hasPrivOrganFlag == 0">
	  	AND EXISTS (select 1
		from sm_organ_tb sot, sm_organ_parent_tb sopt
		where
		exists (select 1
		from sm_users_tb sut
		where sut.user_no = #{userNo}
		and sot.organ_no = sut.organ_no)
		and sot.organ_no = sopt.parent_organ
		and sopt.organ_no=t1.site_no
		)
	    </if>
	</if>	
	) tt2
	where tt1.batch_id=tt2.batch_id order by task_count2 desc
	) tt3

    <if test="queryType == '0'.toString()">
      where task_count2>0
    </if>
  </select>
  
  
  <update id="updateTmpBatch" parameterType="java.util.HashMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update bp_tmpbatch_tb
    <set>
      <if test="newBatchLock != null">
        BATCH_LOCK = #{newBatchLock,jdbcType=CHAR},
      </if>
      <if test="newBatchTotalPage != null">
        BATCH_TOTAL_PAGE = #{newBatchTotalPage,jdbcType=VARCHAR},
      </if>
      <if test="newBusinessId != null">
        BUSINESS_ID = #{newBusinessId,jdbcType=DECIMAL},
      </if>
      <if test="newBatchCommit != null">
        BATCH_COMMIT = #{newBatchCommit,jdbcType=CHAR},
      </if>
      <if test="newInputDate != null">
        INPUT_DATE = #{newInputDate,jdbcType=CHAR},
      </if>
      <if test="newTempDataTable != null">
        TEMP_DATA_TABLE = #{newTempDataTable,jdbcType=VARCHAR},
      </if>
      <if test="newInputWorker != null">
        INPUT_WORKER = #{newInputWorker,jdbcType=VARCHAR},
      </if>
      <if test="newMachineId != null">
        MACHINE_ID = #{newMachineId,jdbcType=VARCHAR},
      </if>
      <if test="newNeedProcess != null">
        NEED_PROCESS = #{newNeedProcess,jdbcType=CHAR},
      </if>
      <if test="newOccurDate != null">
        OCCUR_DATE = #{newOccurDate,jdbcType=VARCHAR},
      </if>
      <if test="newOperatorNo != null">
        OPERATOR_NO = #{newOperatorNo,jdbcType=VARCHAR},
      </if>
      <if test="newProgressFlag != null">
        PROGRESS_FLAG = #{newProgressFlag,jdbcType=CHAR},
      </if>
      <if test="newSiteNo != null">
        SITE_NO = #{newSiteNo,jdbcType=VARCHAR},
      </if>
      <if test="newInputTime != null">
        INPUT_TIME = #{newInputTime,jdbcType=CHAR},
      </if>
      <if test="newImageStatus != null">
        IMAGE_STATUS = #{newImageStatus,jdbcType=CHAR},
      </if>
      <if test="newIsInvalid != null">
        IS_INVALID = #{newIsInvalid,jdbcType=CHAR},
      </if>
      <if test="newPriorityLevel != null">
        PRIORITY_LEVEL = #{newPriorityLevel,jdbcType=CHAR},
      </if>
      <if test="newWorker != null">
        WORKER = #{newWorker,jdbcType=VARCHAR},
      </if>
      <if test="newWorkTime != null">
        WORK_TIME = #{newWorkTime,jdbcType=VARCHAR},
      </if>
        <if test="newOcrFactorFlag != null">
        OCR_FACTOR_FLAG = #{newOcrFactorFlag,jdbcType=CHAR},
      </if>
        <if test="newProcinstId != null">
        PROCINSTID = #{newProcinstId,jdbcType=DECIMAL},
      </if>
    </set>
    where   
     BATCH_ID = #{batchId,jdbcType=CHAR}
  </update>
  
    <update id="updateBatchTask">
  update BP_PATCHTASK_TB set status='1' where batch_id=#{batchId}
  </update>
  
  <update id="updateTotalPage" parameterType="java.util.HashMap">
    update BP_TMPBATCH_TB
    set BATCH_TOTAL_PAGE = (SELECT BP.BATCH_TOTAL_PAGE + ${addCount} FROM BP_TMPBATCH_TB BP WHERE BP.BATCH_ID = #{batchId,jdbcType=CHAR})   
    where BATCH_ID = #{batchId,jdbcType=CHAR}
  </update>
  
  <select id="selectPatchTask" parameterType="java.lang.String" resultType="java.util.HashMap">
    select BATCH_ID, OPERATOR_WORKER, STATUS, PATCH_DES
    from bp_patchtask_tb
    where BATCH_ID = #{batchId,jdbcType=VARCHAR}
  </select>
  
  <insert id="insertPatchTask" parameterType="java.util.HashMap">
  	insert into bp_patchtask_tb (BATCH_ID, OPERATOR_WORKER, STATUS, PATCH_DES) values 
  	(#{batchId,jdbcType=VARCHAR},#{operatorWorker,jdbcType=VARCHAR},#{status,jdbcType=CHAR},#{patchDes,jdbcType=VARCHAR})
  </insert>
  <!--获取批次列表-->
  <select id="selectBatchList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
    select TB.BATCH_ID,TB.INPUT_DATE, TB.TEMP_DATA_TABLE, TB.PROGRESS_FLAG, TB.SITE_NO,TB.OPERATOR_NO 
    from BP_TMPBATCH_TB TB
    LEFT JOIN BP_TMPDATA_1_TB TD ON TD.BATCH_ID=TB.BATCH_ID 
    <where>
    	<if test="needProcess != null">
    		AND TB.NEED_PROCESS = #{needProcess,jdbcType=CHAR}
    	</if>
    	<if test="formName != null and formName != ''">
    		  AND TD.FORM_NAME= #{formName,jdbcType=VARCHAR}
    	</if>
    	<if test="imageList != null">
    		AND TD.CHECK_FLAG IN
    		<foreach collection="imageList" item="imCheckFlag" open="(" separator="," close=")">
		        #{imCheckFlag}
			</foreach>
    	</if>
    	AND TB.IS_INVALID ='1' AND TB.OPERATOR_NO =#{operatorNo,jdbcType=VARCHAR} AND TB.SITE_NO =#{siteNo,jdbcType=VARCHAR} AND TB.OCCUR_DATE = #{occurDate,jdbcType=VARCHAR}
    </where>
  </select>
  
  <select id="getTableName" parameterType="java.util.HashMap" resultType="java.util.HashMap">
    SELECT B.TABLE_NAME BP_BATCH_TB,C.TABLE_NAME BP_DATA_TB,D.TABLE_NAME FL_FLOW_TB 
    FROM SM_ORGAN_DATA_TB A,SM_TABLE_DEF_TB B,SM_TABLE_DEF_TB C,SM_TABLE_DEF_TB D 
    WHERE A.ORGAN_NO=#{siteNo,jdbcType=VARCHAR}  AND A.TMPBATCH_TB_ID=B.TABLE_ID AND A.TMPDATA_TB_ID=C.TABLE_ID AND A.FLOW_TB_ID=D.TABLE_ID
  </select>
  
  <select id="getBatchInfo" parameterType="java.util.HashMap" resultType="java.util.HashMap">
    SELECT A.BATCH_ID, A.IMAGE_STATUS, A.PROGRESS_FLAG, A.TEMP_DATA_TABLE
    FROM BP_TMPBATCH_TB A
   	<where>
   		<if test="businessId != null and businessId != ''">
    		and A.BUSINESS_ID = #{businessId,jdbcType=DECIMAL}
    	</if>
    	<if test="needProcess != null and needProcess != ''">
    		and A.NEED_PROCESS = #{needProcess,jdbcType=DECIMAL}
    	</if>
    	<if test="operatorNo != null and operatorNo != ''">
    		and A.OPERATOR_NO = #{operatorNo,jdbcType=DECIMAL}
    	</if>
    	 AND IS_INVALID ='1'  AND SITE_NO =#{siteNo,jdbcType=VARCHAR}  AND
    	OCCUR_DATE &gt;= #{startDate,jdbcType=VARCHAR} AND OCCUR_DATE &lt;= #{endDate,jdbcType=VARCHAR} 
   	</where>
   	
  </select>
  
  <select id="getScanBatch" resultType="java.util.HashMap">
    SELECT T.BATCH_ID,T.OCCUR_DATE,T.SITE_NO,T.OPERATOR_NO,s.SERVICE_ID FROM bp_tmpbatch_tb T join SM_ORGAN_DATA_TB s on T.SITE_NO = S.ORGAN_NO
     WHERE T.BATCH_COMMIT = '1' AND T.NEED_PROCESS = '1' AND T.IS_INVALID = '1' AND T.PROCINSTID = 0 AND T.PROGRESS_FLAG = '10'
     AND EXISTS (SELECT 1 FROM FL_MON_DATA_TB C WHERE C.OCCUR_DATE = T.OCCUR_DATE AND C.OP_FLAG = '1') ORDER BY T.BATCH_ID
  </select>
  
  <update id="updateFlowId" parameterType="java.util.HashMap">
   	begin
   	<foreach separator=";" index="index" item="item" collection="flowIdMap.keys" close="" open="">
   		update BP_TMPBATCH_TB
   		<set>
   			PROCINSTID =#{flowIdMap[${item}]},
   			
   			AREA_CODE = (SELECT SERVICE_ID FROM SM_ORGAN_DATA_TB T1 JOIN  BP_TMPBATCH_TB T2 ON T1.ORGAN_NO=T2.SITE_NO WHERE T2.BATCH_ID = #{item})
   		</set>
		where BATCH_ID = #{item}
   	</foreach>
	;end;  
  </update>
  
	<!-- 查询该批次的所属机构号(site_no)的所有权限机构用户 -->
	<select id="getFlowUserList" parameterType="java.util.HashMap"
		resultType="java.util.HashMap">
		SELECT U.USER_NO FROM SM_USERS_TB U JOIN SM_USER_ORGAN_TB O ON U.USER_NO 
			= O.USER_NO JOIN SM_USER_ROLE_TB UR ON U.USER_NO = UR.USER_NO WHERE O.ORGAN_NO 
			= (SELECT T.SITE_NO FROM BP_TMPBATCH_TB T WHERE T.BATCH_ID = #{batchId,jdbcType=VARCHAR}) 
			AND UR.ROLE_NO IN (SELECT DISTINCT(R.ROLE_NO) FROM SM_RIGHT_TB R JOIN SM_MENU_TB 
			M ON R.MENU_ID = M.MENU_ID WHERE M.MENU_NAME = (SELECT S.PARAM_VALUE FROM 
			SM_SYSPARAMETER_TB S WHERE S.PARAM_ITEM = 'MA') )
		<!-- SELECT U.USER_NO
		FROM SM_USERS_TB U
		JOIN SM_USER_ROLE_TB UR
		ON U.USER_NO = UR.USER_NO
		WHERE UR.ROLE_NO IN
		(SELECT DISTINCT (R.ROLE_NO)
		FROM SM_RIGHT_TB R
		JOIN SM_MENU_TB M
		ON R.MENU_ID = M.MENU_ID
		WHERE M.MENU_NAME = (SELECT S.PARAM_VALUE
		FROM SM_SYSPARAMETER_TB S
		WHERE S.PARAM_ITEM = 'MA'))
		<if test="hasPrivOrganFlag != 0">
		and exists (select 1
		from SM_USER_ORGAN_TB o
		where U.USER_NO = O.USER_NO
		and o.organ_no = (SELECT T.SITE_NO
		FROM BP_TMPBATCH_TB T
		WHERE T.BATCH_ID = #{batchId,jdbcType=VARCHAR}
		))
		</if>
		<if test="hasPrivOrganFlag == 0">
		AND EXISTS (select 1
		from sm_organ_tb sot, sm_organ_parent_tb sopt
		where
		exists (select 1
		from sm_users_tb sut
		where sut.user_no = U.USER_NO 
		and sot.organ_no = sut.organ_no)
		and sot.organ_no = sopt.parent_organ
		and sopt.organ_no= (SELECT T.SITE_NO
		FROM BP_TMPBATCH_TB T
		WHERE T.BATCH_ID = #{batchId,jdbcType=VARCHAR}
		)
		)
		</if> -->

	</select>
	
	<!-- 查询该批次的所属机构号(site_no)的所有上级机构(包括自己)的用户,再排除掉权限机构表中存在的用户 -->
	<select id="getFlowUserList2" parameterType="java.util.HashMap"
		resultType="java.util.HashMap">
		<!-- SELECT U.USER_NO FROM SM_USERS_TB U JOIN SM_USER_ORGAN_TB O ON U.USER_NO 
			= O.USER_NO JOIN SM_USER_ROLE_TB UR ON U.USER_NO = UR.USER_NO WHERE O.ORGAN_NO 
			= (SELECT T.SITE_NO FROM BP_TMPBATCH_TB T WHERE T.BATCH_ID = #{batchId,jdbcType=VARCHAR}) 
			AND UR.ROLE_NO IN (SELECT DISTINCT(R.ROLE_NO) FROM SM_RIGHT_TB R JOIN SM_MENU_TB 
			M ON R.MENU_ID = M.MENU_ID WHERE M.MENU_NAME = (SELECT S.PARAM_VALUE FROM 
			SM_SYSPARAMETER_TB S WHERE S.PARAM_ITEM = 'MA') ) -->
		SELECT U.USER_NO
		FROM SM_USERS_TB U
		JOIN SM_USER_ROLE_TB UR
		ON U.USER_NO = UR.USER_NO
		WHERE UR.ROLE_NO IN
		(SELECT DISTINCT (R.ROLE_NO)
		FROM SM_RIGHT_TB R
		JOIN SM_MENU_TB M
		ON R.MENU_ID = M.MENU_ID
		WHERE M.MENU_NAME = (SELECT S.PARAM_VALUE
		FROM SM_SYSPARAMETER_TB S
		WHERE S.PARAM_ITEM = 'MA'))
		and exists (select 1
		from sm_users_tb sut
		where exists (select 1
		from sm_organ_parent_tb sopt
		where sopt.organ_no = (SELECT
		T.SITE_NO
		FROM BP_TMPBATCH_TB T
		WHERE T.BATCH_ID = #{batchId,jdbcType=VARCHAR}
		)
		and sut.organ_no = sopt.parent_organ)
		and sut.user_no = U.USER_NO)
		and not exists
		(select 1 from SM_USER_organ_TB suot where suot.user_no = U.User_No)

	</select>
  <select id="hasArchiveBatch" parameterType="java.util.HashMap" resultType="java.lang.Integer">
  	SELECT count(1) FROM BP_TMPBATCH_TB
   	<where>
   		<if test="occurDate != null">
       	AND OCCUR_DATE = #{occurDate,jdbcType=VARCHAR}
      </if>
      <if test="operatorNo != null">
      	AND  OPERATOR_NO = #{operatorNo,jdbcType=VARCHAR}
      </if>
   	<if test="siteNo != null">
   		AND SITE_NO = #{siteNo,jdbcType=VARCHAR}
   	</if>
   	  <if test="progressFlag != null">
      	 AND PROGRESS_FLAG  &lt; #{progressFlag,jdbcType=CHAR}
      </if>
       <if test="progressFlag == 98">
      	 AND NEED_PROCESS  != '0'
      </if>
      </where>
   		AND IS_INVALID = '1' AND BUSINESS_ID != 99  AND BUSINESS_ID != 98 
  </select>
  
  <select id="getArchiveBatchs" parameterType="java.util.HashMap" resultMap="BaseResultMap">
  	SELECT 
  	 <include refid="Base_Column_List" />
  	FROM BP_TMPBATCH_TB
   	<where>
   		<if test="occurDate != null">
       	AND OCCUR_DATE = #{occurDate,jdbcType=VARCHAR}
      </if>
      <if test="operatorNo != null">
      	AND  OPERATOR_NO = #{operatorNo,jdbcType=VARCHAR}
      </if>
   	<if test="siteNo != null">
   		AND SITE_NO = #{siteNo,jdbcType=VARCHAR}
   	</if>
   		AND IS_INVALID = '1' AND BUSINESS_ID != 99  AND BUSINESS_ID != 98 AND PROGRESS_FLAG != 99 AND ( ( PROGRESS_FLAG = 98 AND NEED_PROCESS = 1 AND IMAGE_STATUS = 1 ) OR NEED_PROCESS = 0 )
   </where>
  </select>
  
   <select id="isVouh"  resultType="java.lang.Integer">
   		SELECT count(1) FROM  BP_TMPBATCH_TB 
   		<where>
   			BUSINESS_ID = '0' AND
   			BATCH_ID in 
   			<foreach collection="list" open="(" close=")" item="id" separator=",">
   				#{id}
   			</foreach>
   		</where>
   </select>
   
   <select id="getVouh" parameterType="java.util.HashMap" resultMap="BaseResultMap">
  	SELECT 
  	 <include refid="Base_Column_List" />
  	FROM BP_TMPBATCH_TB
   	<where>
   		<if test="occurDate != null">
       	AND OCCUR_DATE = #{occurDate,jdbcType=VARCHAR}
      </if>
      <if test="operatorNo != null">
      	AND  OPERATOR_NO = #{operatorNo,jdbcType=VARCHAR}
      </if>
   	<if test="siteNo != null">
   		AND SITE_NO = #{siteNo,jdbcType=VARCHAR}
   	</if>
   		AND IS_INVALID = '1' AND BUSINESS_ID = '0' AND PROGRESS_FLAG &lt; 98
   </where>
  </select>
  
  
  <delete id="deletehisBatchData"  >
   		DELETE FROM  BP_TMPDATA_1_TB_HIS 
   		<where>
   			BATCH_ID in 
   			<foreach collection="list" open="(" close=")" item="id" separator=",">
   				#{id}
   			</foreach>
   		</where>
   </delete>
   
   <update id="updateBatchArchive" >
   		UPDATE BP_TMPBATCH_TB SET PROGRESS_FLAG= '99' ,	IMAGE_STATUS = '2' 
   		<where>
   			BATCH_ID in 
   			<foreach collection="list" open="(" close=")" item="id" separator=",">
   				#{id}
   			</foreach>
   		</where>
   </update>
   
      <update id="tmpbatchBackArchive" >
   		UPDATE BP_TMPBATCH_TB SET PROGRESS_FLAG= '98' ,	IMAGE_STATUS = '1' 
   		<where>
   			BATCH_ID in 
   			<foreach collection="list" open="(" close=")" item="id" separator=",">
   				#{id}
   			</foreach>
   		</where>
   </update>
   
    <select id="updateArchiveBatch" parameterType="java.util.HashMap" >
  	UPDATE  BP_TMPBATCH_TB SET IMAGE_STATUS= '3' 
   	<where>
   		<if test="occurDate != null">
       	AND OCCUR_DATE = #{occurDate,jdbcType=VARCHAR}
      </if>
      <if test="operatorNo != null">
      	AND  OPERATOR_NO = #{operatorNo,jdbcType=VARCHAR}
      </if>
   	<if test="siteNo != null">
   		AND SITE_NO = #{siteNo,jdbcType=VARCHAR}
   	</if>
   		AND IMAGE_STATUS = '2' AND PROGRESS_FLAG= '99' "
   </where>
  </select>
   
     <select id="existsBatch" parameterType="java.util.HashMap" resultType="java.lang.Integer">
  	SELECT COUNT(1)
  	FROM BP_TMPBATCH_TB
   	<where>
   		<if test="occurDate != null">
       	AND OCCUR_DATE = #{occurDate,jdbcType=VARCHAR}
      </if>
      <if test="operatorNo != null">
      	AND  OPERATOR_NO = #{operatorNo,jdbcType=VARCHAR}
      </if>
   	<if test="siteNo != null">
   		AND SITE_NO = #{siteNo,jdbcType=VARCHAR}
   	</if>
   		AND IMAGE_STATUS != '3' AND BUSINESS_ID != '99' AND BUSINESS_ID != '98' AND IS_INVALID='1'
   </where>
  </select>
  
   <update id="patchBatchLock">
  	update BP_TMPBATCH_TB set BATCH_LOCK = '1' , BATCH_COMMIT= '0'  where batch_id=#{batchId} and BATCH_LOCK = '0'
  </update>
  
   <update id="patchBatchUnlock">
  	update BP_TMPBATCH_TB set BATCH_LOCK = '0' , BATCH_COMMIT= '1'  where batch_id=#{batchId} 
  </update>

	
 <select id="getPatchBatchs" parameterType="java.util.HashMap" >
  	SELECT BATCH_ID FROM BP_TMPBATCH_TB
   	<where>
      <if test="inputWorker != null">
      	AND  INPUT_WORKER = #{inputWorker,jdbcType=VARCHAR}
      </if>
   	<if test="siteNos != null">
   		AND SITE_NO IN
   		<foreach collection="siteNos" open="(" close=")" item="siteNo" separator=",">
   				#{siteNo}
   			</foreach>
   	</if>
   </where>
  </select>
  
    <update id="updateSendstatus">
 	 update BP_TMPBATCH_TB set IS_INVALID='1',CONTENT_ID=#{contentId} where IS_INVALID='0' and  batch_id=#{batchId}
  	</update>
  	
  	
  	
    <select id="getBatchCount"  resultType="java.util.HashMap">    
	select t.progress_Flag,t.SITE_NO,count(t.batch_Id)CNT from Bp_Tmpbatch_Tb t											   
	<where> 
	    <if test="siteNo != null and siteNo.size() !=0">
	        t.SITE_NO in 
		   <foreach collection="siteNo" item="siteNoTmp" open="("
				separator="," close=")">
				#{siteNoTmp}
			</foreach> 
		</if>
	    <if test="occurDate != null and occurDate != ''">
	        and  t.OCCUR_DATE =#{occurDate,jdbcType=VARCHAR}
	    </if>
	</where>
    group by t.progress_Flag,t.SITE_NO 
  </select> 
   <select id="getBatchCount2"  resultType="java.util.HashMap">    
	select t.progress_Flag,t.operator_No,count(t.batch_Id)CNT from Bp_Tmpbatch_Tb t											   
	<where> 
	    <if test="tellers != null and tellers.size() !=0">
	     t.operator_No in 
		   <foreach collection="tellers" item="tellersTmp" open="("
				separator="," close=")">
				#{tellersTmp}
			</foreach> 
		</if>
	    <if test="occurDate != null and occurDate != ''">
	        and  t.OCCUR_DATE =#{occurDate,jdbcType=VARCHAR}
	    </if>
	</where>
    group by t.progress_Flag,t.operator_No 
  </select> 
  
  <select id="getBatchIdandInputDate" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT DISTINCT BTB.BATCH_ID,BTB.INPUT_DATE FROM FL_FLOW_TB FLT
		INNER JOIN BP_TMPDATA_1_TB BTD ON BTD.SERIAL_NO=FLT.LSERIAL_NO
		INNER JOIN BP_TMPBATCH_TB BTB ON BTB.BATCH_ID=BTD.BATCH_ID
	  <where>
	  	<if test="occurDate != null and occurDate != ''">
	  		 FLT.OCCUR_DATE=#{occurDate,jdbcType=VARCHAR}
	  	</if>
	  	<if test="flowId != null and flowId != ''">
	  		 AND FLT.FLOW_ID=#{flowId,jdbcType=VARCHAR}
	  	</if>
	  	<if test="siteNo != null and siteNo != ''">
	  		 AND FLT.SITE_NO=#{siteNo,jdbcType=VARCHAR}
	  	</if>
	  	<if test="operatorNo != null and operatorNo != ''">
	  		AND FLT.OPERATOR_NO=#{operatorNo,jdbcType=VARCHAR}
	  	</if>
	  </where>
  </select>

  <select id="getFileNamesList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
    
   SELECT T.FILE_NAME,T.BACK_FILE_NAME,T.INCCODEIN_BATCH FROM  BP_TMPDATA_1_TB T 
     WHERE T.BATCH_ID=#{batchId,jdbcType=VARCHAR} 
     AND EXISTS(SELECT 1 FROM FL_FLOW_TB FLT WHERE FLT.LSERIAL_NO=T.SERIAL_NO  AND FLT.FLOW_ID=#{flowId,jdbcType=VARCHAR})
    UNION ALL 
   SELECT TALL.FILE_NAME,TALL.BACK_FILE_NAME,TALL.INCCODEIN_BATCH FROM (
    SELECT TW.FILE_NAME,TW.BACK_FILE_NAME,TW.INCCODEIN_BATCH FROM BP_TMPDATA_1_TB TW JOIN
    (        
     SELECT T.BATCH_ID,T.INCCODEIN_BATCH,T.PRIMARY_INCCODEIN FROM  BP_TMPDATA_1_TB T 
     WHERE T.BATCH_ID=#{batchId,jdbcType=VARCHAR} 
     AND EXISTS(SELECT 1 FROM FL_FLOW_TB FLT WHERE FLT.LSERIAL_NO=T.SERIAL_NO  AND FLT.FLOW_ID=#{flowId,jdbcType=VARCHAR})
    ) RE   ON TW.BATCH_ID=RE.BATCH_ID AND TW.PRIMARY_INCCODEIN=RE.INCCODEIN_BATCH  ORDER BY INCCODEIN_BATCH ASC
   ) TALL 
  </select>	
  
  	<!-- 批次进工作流加锁 -->
    <update id="batchToFlowLock">
  	   update bp_tmpbatch_tb t set t.work_time = to_char(sysdate,'yyyymmddHH24miss') where batch_id=#{batchId} and t.procinstid =0 and (work_time is null or (ceil((sysdate - to_date(work_time,'yyyymmddHH24miss'))*24*60)> #{batchLockTime}))
  	</update> 
  	

  	
  	<!--按条件查询批次  -->
  	<select id="selectBySelective"  parameterType="java.util.HashMap" resultMap="BaseResultMap">
  	    select 
    <include refid="Base_Column_List" />
    from BP_TMPBATCH_TB
    <where>
      <if test="batch.batchId !=null and batch.batchId !=''">
      AND BATCH_ID=#{batch.batchId}
      </if>
      <if test="batch.batchLock != null and batch.batchLock !=''">
       AND   BATCH_LOCK = #{batch.batchLock,jdbcType=CHAR}
      </if>
      <if test="batch.batchTotalPage != null and batch.batchTotalPage !=''">
       AND  BATCH_TOTAL_PAGE = #{batch.batchTotalPage,jdbcType=VARCHAR}
      </if>
      <if test="batch.businessId != null and batch.businessId !=''">
      AND  BUSINESS_ID = #{batch.businessId,jdbcType=DECIMAL}
      </if>
      <if test="batch.batchCommit != null and batch.batchCommit !=''">
      AND BATCH_COMMIT = #{batch.batchCommit,jdbcType=CHAR}
      </if>
      <if test="batch.inputDate != null and batch.inputDate !=''">
      AND  INPUT_DATE = #{batch.inputDate,jdbcType=CHAR}
      </if>
      <if test="batch.inputWorker != null and batch.inputWorker !=''">
      AND  INPUT_WORKER = #{batch.inputWorker,jdbcType=VARCHAR}
      </if>
      <if test="batch.needProcess != null and batch.needProcess !=''">
      AND  NEED_PROCESS = #{batch.needProcess,jdbcType=CHAR}
      </if>
      <if test="batch.occurDate != null and batch.occurDate !=''">
      AND  OCCUR_DATE = #{batch.occurDate,jdbcType=VARCHAR}
      </if>
      <if test="batch.operatorNo != null and batch.operatorNo !=''">
      AND  OPERATOR_NO = #{batch.operatorNo,jdbcType=VARCHAR}
      </if>
      <if test="batch.progressFlag != null and batch.progressFlag !=''">
      AND  PROGRESS_FLAG = #{batch.progressFlag,jdbcType=CHAR}
      </if>
      <if test="batch.siteNo != null and batch.siteNo !=''">
       AND SITE_NO = #{batch.siteNo,jdbcType=VARCHAR}
      </if>
      <if test="batch.imageStatus != null and batch.imageStatus !=''">
      AND  IMAGE_STATUS = #{batch.imageStatus,jdbcType=CHAR}
      </if>
      <if test="batch.isInvalid != null and batch.isInvalid !=''">
       AND IS_INVALID = #{batch.isInvalid,jdbcType=CHAR}
      </if>
       <if test="batch.ocrFactorFlag != null and batch.ocrFactorFlag !=''">
      AND  OCR_FACTOR_FLAG = #{batch.ocrFactorFlag,jdbcType=CHAR}
      </if>
      <if  test="batch.procinstId !=null and batch.procinstId !=''">
      AND PROCINSTID = #{batch.procinstId}
      </if>
      
      <if test="userNo!=null and userNo!='' and hasPrivOrganFlag != 0">
      AND SITE_NO in (select organ_no from sm_user_organ_tb where user_no = #{userNo})
	    </if>
	    <if test="userNo!=null and userNo!='' and hasPrivOrganFlag == 0">
	  	AND EXISTS (select 1
		from sm_organ_tb sot, sm_organ_parent_tb sopt
		where
		exists (select 1
		from sm_users_tb sut
		where sut.user_no = #{userNo}
		and sot.organ_no = sut.organ_no)
		and sot.organ_no = sopt.parent_organ
		and sopt.organ_no=SITE_NO
		)
	    </if>
      
      
    </where>   
    order by PROGRESS_FLAG,OCCUR_DATE,SITE_NO,OPERATOR_NO
  	</select>
  	
  	
  	
</mapper>